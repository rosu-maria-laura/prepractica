#include <iostream>
#include <string>
#include <PubSubClient.h>

const char* mqttServer = "mqtt.beia-telemetrie.ro";
const int mqttPort = 1883;
const char* mqttTopic = "/training/device/prenume-nume/";
//const char* mqttClientID = "mqtt-client";

WiFiClient espClient;
PubSubClient client(espClient);

void setup() {
    Serial.begin(115200);
    client.setServer(mqttServer, mqttPort);
}

void loop() {
    if (!client.connected()) {
        reconnect();
    }

    client.loop();

    if (Serial.available()) {
        int number = Serial.parseInt();

        Serial.print("You entered: ");
        Serial.println(number);

        char payload[10];
        snprintf(payload, sizeof(payload), "%d", number);

        client.publish(mqttTopic, payload);
    }
}

void reconnect() {
    while (!client.connected()) {
        Serial.println("Connecting to MQTT...");
        if (client.connect(mqttClientID)) {
            Serial.println("Connected to MQTT");
            client.subscribe(mqttTopic);  // Subscribe to the topic if needed
        }
        else {
            Serial.print("Failed to connect to MQTT, rc=");
            Serial.print(client.state());
            Serial.println(" Retrying in 5 seconds...");
            delay(5000);
        }
    }
}
